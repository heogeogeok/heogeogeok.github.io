<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"><link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"><style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(2)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(2) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(2) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list { display: block; }</style><script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico" type="image/x-icon"><title>2.2. Indexes | The Internals of MongoDB</title><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="2.2. Indexes" /><meta property="og:locale" content="en_US" /><meta name="description" content="A Jekyll theme for documentation" /><meta property="og:description" content="A Jekyll theme for documentation" /><link rel="canonical" href="http://localhost:4000/docs/mongo02/02/" /><meta property="og:url" content="http://localhost:4000/docs/mongo02/02/" /><meta property="og:site_name" content="The Internals of MongoDB" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="2.2. Indexes" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A Jekyll theme for documentation","headline":"2.2. Indexes","url":"http://localhost:4000/docs/mongo02/02/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> The Internals of MongoDB </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 1. Databases and Collections category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo01" class="nav-list-link">1. Databases and Collections</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo01/01/" class="nav-list-link">1.1. Database Internals</a><li class="nav-list-item"><a href="/docs/mongo01/02/" class="nav-list-link">1.2. Architecture</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2. Memory Management category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo02" class="nav-list-link">2. Memory Management</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo02/01/" class="nav-list-link">2.1. Data Storage</a><li class="nav-list-item"><a href="/docs/mongo02/02/" class="nav-list-link">2.2. Indexes</a><li class="nav-list-item"><a href="/docs/mongo02/03/" class="nav-list-link">2.3. Concurrency Control</a><li class="nav-list-item"><a href="/docs/mongo02/04/" class="nav-list-link">2.4. Page Operations</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 3. Block Manager category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo03" class="nav-list-link">3. Block Manager</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo03/01/" class="nav-list-link">3.1. Page Operations</a><li class="nav-list-item"><a href="/docs/mongo03/02/" class="nav-list-link">3.2. Checksum</a><li class="nav-list-item"><a href="/docs/mongo03/03/" class="nav-list-link">3.3. Space Management</a><li class="nav-list-item"><a href="/docs/mongo03/04/" class="nav-list-link">3.4. Compression</a><li class="nav-list-item"><a href="/docs/mongo03/05/" class="nav-list-link">3.5. Logging</a></ul><li class="nav-list-item"><a href="/docs/" class="nav-list-link">References</a></ul><ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/heogeogeok" class="nav-list-link external" > GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search The Internals of MongoDB" aria-label="Search The Internals of MongoDB" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div></div><div class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/docs/mongo02">2. Memory Management</a><li class="breadcrumb-nav-list-item"><span>2.2. Indexes</span></ol></nav><div id="main-content" class="main-content"><main><div style="text-align: center;" class="fs-10"> 2.2. INDEXES</div><p>Indexing is a critical feature in MongoDB, especially when managing large collections with tens of thousands of documents. Without indexes, MongoDB would need to perform a full collection scan to find specific data, much like a librarian searching every book in a library. Indexes in MongoDB, however, allow for rapid document retrieval, similar to how the Dewey Decimal system helps a librarian locate books efficiently.</p><h2 id="221-indexing"> <a href="#221-indexing" class="anchor-heading" aria-labelledby="221-indexing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.2.1. Indexing</h2><h3 id="_id-index"> <a href="#_id-index" class="anchor-heading" aria-labelledby="_id-index"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <code class="language-plaintext highlighter-rouge">_id</code> Index</h3><ul><li><p><strong>Automatic Indexing</strong>:<br /> When you create a collection in MongoDB, a primary key called <code class="language-plaintext highlighter-rouge">_id</code> is automatically generated for each document. This key is indexed using a B+Tree structure to optimize search operations. The <code class="language-plaintext highlighter-rouge">_id</code> uniquely identifies each document and can be used to efficiently locate it.</p><li><p><code class="language-plaintext highlighter-rouge">ObjectId</code>:<br /> The <code class="language-plaintext highlighter-rouge">_id</code> field is typically of type <code class="language-plaintext highlighter-rouge">ObjectId</code>, a 12-byte identifier. Its size ensures unique identification across distributed systems, like sharded clusters. Users can override the <code class="language-plaintext highlighter-rouge">_id</code> field with their own values, which might increase the key size, potentially impacting performance.</p><li><p><strong>Primary Index</strong>:<br /> The primary index maps the <code class="language-plaintext highlighter-rouge">_id</code> to the corresponding BSON document through a B+Tree structure. As MongoDB has evolved, the way this mapping is handled has also changed, which will be explored in the following sections.</p></ul><h3 id="secondary-indexes"> <a href="#secondary-indexes" class="anchor-heading" aria-labelledby="secondary-indexes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Secondary Indexes</h3><ul><li><p><strong>Custom Indexing</strong>:<br /> MongoDB allows the creation of secondary B+Tree indexes on any field within a collection. These indexes point back to BSON documents that satisfy the index criteria, enabling fast data retrieval using various fields, not just <code class="language-plaintext highlighter-rouge">_id</code>. Without secondary indexes, MongoDB would need to scan the entire collection, field by field, to locate specific data.</p><li><p><strong>Index Size</strong>:<br /> The size of a secondary index depends on two factors: the size of the indexed field (key size) and the size of the document pointer. The efficiency and storage requirements of these indexes can vary depending on the MongoDB version and storage engine in use.</p></ul><h2 id="222-evolution-of-mongodbs-indexing"> <a href="#222-evolution-of-mongodbs-indexing" class="anchor-heading" aria-labelledby="222-evolution-of-mongodbs-indexing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.2.2. Evolution of MongoDB’s Indexing</h2><h3 id="mmapv1"> <a href="#mmapv1" class="anchor-heading" aria-labelledby="mmapv1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> MMAPv1</h3><ul><li><strong><code class="language-plaintext highlighter-rouge">Diskloc</code></strong>:<br /> Initially, MongoDB used the MMAPv1 storage engine, where BSON documents were stored directly on disk without compression. The <code class="language-plaintext highlighter-rouge">_id</code> primary key index mapped to a <code class="language-plaintext highlighter-rouge">Diskloc</code> value, a pair of 32-bit integers representing the file number and offset on disk where the document was stored.</ul><div style="text-align: center;"> <img src="/assets/images/index-mmapv1.png" alt="index-mmapv1" width="500" /></div><ul><li><strong>Challenges</strong>:<br /> While <code class="language-plaintext highlighter-rouge">Diskloc</code> allowed for O(1) retrieval of documents, it was difficult to maintain as documents were inserted or updated. Updates that changed document sizes required recalculating offsets for all subsequent documents, leading to inefficiencies. Additionally, MMAPv1 employed a single global database lock for writes, which severely limited concurrent write operations.</ul><h3 id="wiredtiger"> <a href="#wiredtiger" class="anchor-heading" aria-labelledby="wiredtiger"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> WiredTiger</h3><ul><li><strong>MongoDB v4.2-5.2</strong>:<br /> In 2014, MongoDB acquired WiredTiger, which became the default storage engine. WiredTiger introduced several enhancements, such as document-level locking and compression, allowing for more efficient concurrent writes within the same collection. BSON documents in WiredTiger are compressed and stored in a hidden index, where leaf pages are recordId-BSON pairs. This design allows for more efficient I/O operations, improving overall performance.</ul><p><img src="/assets/images/index-old.png" alt="index-old" /></p><blockquote class="warning"><p><strong>Double Lookup Cost</strong> <br /> With WiredTiger, the primary index <code class="language-plaintext highlighter-rouge">_id</code> and secondary indexes were modified to point to <code class="language-plaintext highlighter-rouge">recordId</code> instead of <code class="language-plaintext highlighter-rouge">Diskloc</code>. This change, while beneficial, introduced a double lookup cost: retrieving a document required first finding the <code class="language-plaintext highlighter-rouge">recordId</code> via the <code class="language-plaintext highlighter-rouge">_id</code> index and then performing a second lookup on the hidden WiredTiger index to access the BSON document. Despite this overhead, the size of both primary and secondary indexes remained predictable, thanks to the 64-bit <code class="language-plaintext highlighter-rouge">recordId</code>.</p></blockquote><ul><li><strong>MongoDB v5.3~</strong>:<br /> In June 2022, MongoDB introduced <strong>clustered collections</strong>, where the primary <code class="language-plaintext highlighter-rouge">_id</code> index became a clustered index. In this setup, all fields are stored in the leaf page, enabling index-only scans. This change means that <strong>looking up a document by <code class="language-plaintext highlighter-rouge">_id</code> directly returns the BSON document</strong>, eliminating the need for a second lookup.</ul><div style="text-align: center;"> <img src="/assets/images/index-new.png" alt="index-new" width="500" /></div><blockquote class="warning"><p><strong>Impact on Secondary Indexes</strong> <br /> With clustered collections, secondary indexes now point to the <code class="language-plaintext highlighter-rouge">_id</code> field rather than <code class="language-plaintext highlighter-rouge">recordId</code>. This change increases the size of secondary indexes, as they must store the 12-byte <code class="language-plaintext highlighter-rouge">_id</code> value (or more if overridden by the user). This can significantly bloat secondary indexes, impacting performance and memory usage, especially in data-intensive applications.</p></blockquote></main><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2017-2020 Patrick Marsceill. Distributed by an <a href="https://github.com/just-the-docs/just-the-docs/tree/main/LICENSE.txt">MIT license.</a> <a href="https://www.netlify.com/">This site is powered by Netlify.</a></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/just-the-docs/just-the-docs/tree/main/docs/mongo02/02.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
