<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"><link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"><style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(2)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(4) > ul > li:nth-child(2) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(4) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(4) > ul > li:nth-child(2) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(4) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(4) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list { display: block; }</style><script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico" type="image/x-icon"><title>3.2. Space Management | The Internals of MongoDB</title><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="3.2. Space Management" /><meta property="og:locale" content="en_US" /><meta name="description" content="A Jekyll theme for documentation" /><meta property="og:description" content="A Jekyll theme for documentation" /><link rel="canonical" href="http://localhost:4000/docs/mongo03/02/" /><meta property="og:url" content="http://localhost:4000/docs/mongo03/02/" /><meta property="og:site_name" content="The Internals of MongoDB" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="3.2. Space Management" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A Jekyll theme for documentation","headline":"3.2. Space Management","url":"http://localhost:4000/docs/mongo03/02/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> The Internals of MongoDB </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 1. Databases and Collections category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo01" class="nav-list-link">1. Databases and Collections</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo01/01/" class="nav-list-link">1.1. Database Internals</a><li class="nav-list-item"><a href="/docs/mongo01/02/" class="nav-list-link">1.2. Architecture</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2. Memory Management category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo02" class="nav-list-link">2. Memory Management</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo02/01/" class="nav-list-link">2.1. Data Storage</a><li class="nav-list-item"><a href="/docs/mongo02/02/" class="nav-list-link">2.2. Indexes</a><li class="nav-list-item"><a href="/docs/mongo02/03/" class="nav-list-link">2.3. Concurrency Control</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 3. Block Manager category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo03" class="nav-list-link">3. Block Manager</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo03/01/" class="nav-list-link">3.1. Eviction</a><li class="nav-list-item"><a href="/docs/mongo03/02/" class="nav-list-link">3.2. Space Management</a><li class="nav-list-item"><a href="/docs/mongo03/03/" class="nav-list-link">3.3. Compression</a><li class="nav-list-item"><a href="/docs/mongo03/04/" class="nav-list-link">3.4. Logging</a></ul><li class="nav-list-item"><a href="/docs/" class="nav-list-link">References</a></ul><ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/heogeogeok" class="nav-list-link external" > GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search The Internals of MongoDB" aria-label="Search The Internals of MongoDB" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div></div><div class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/docs/mongo03">3. Block Manager</a><li class="breadcrumb-nav-list-item"><span>3.2. Space Management</span></ol></nav><div id="main-content" class="main-content"><main><h3 class="fs-10 text-center" id="32-space-management"> <a href="#32-space-management" class="anchor-heading" aria-labelledby="32-space-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2. SPACE MANAGEMENT</h3><h2 id="321-versioning-and-storage-of-data"> <a href="#321-versioning-and-storage-of-data" class="anchor-heading" aria-labelledby="321-versioning-and-storage-of-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2.1. Versioning and Storage of Data</h2><h3 id="mvcc-mechanism"> <a href="#mvcc-mechanism" class="anchor-heading" aria-labelledby="mvcc-mechanism"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> MVCC Mechanism</h3><p>WiredTiger implements a Multiple Version Concurrency Control (MVCC) mechanism. In MVCC, when a document or record is updated, a new version is created rather than overwriting the existing data. This allows older versions to remain available for transactions that began before the update, ensuring data consistency.</p><h3 id="space-management"> <a href="#space-management" class="anchor-heading" aria-labelledby="space-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Space Management</h3><p>The presence of multiple versions due to MVCC requires efficient space management to prevent the accumulation of old versions from consuming excessive disk space.</p><h2 id="322-handling-dirty-pages"> <a href="#322-handling-dirty-pages" class="anchor-heading" aria-labelledby="322-handling-dirty-pages"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2.2. Handling Dirty Pages</h2><h3 id="dirty-pages"> <a href="#dirty-pages" class="anchor-heading" aria-labelledby="dirty-pages"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dirty Pages</h3><p>When data is modified, the changes are initially stored in memory as “dirty pages.” These pages contain the new versions created by MVCC.</p><h3 id="checkpointing-and-space-management"> <a href="#checkpointing-and-space-management" class="anchor-heading" aria-labelledby="checkpointing-and-space-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Checkpointing and Space Management</h3><p>During the checkpointing process, WiredTiger writes these dirty pages out to disk. This process is not just about persisting changes; it’s also a critical component of space management. As the latest version of data is merged with the original on-disk image, older, outdated versions are effectively replaced, freeing up valuable disk space.</p><h3 id="copy-on-write-strategy"> <a href="#copy-on-write-strategy" class="anchor-heading" aria-labelledby="copy-on-write-strategy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Copy-on-Write Strategy</h3><p>When an update request is received, WiredTiger fetches the corresponding page from storage into DRAM. It then employs a <strong>copy-on-write</strong> approach, which allows multiple versions of the data to exist without locking the original on-disk image. This strategy ensures that updates are efficiently managed while maintaining data consistency, as only the most recent committed versions are preserved and older versions are eventually reclaimed through the checkpointing process.</p><h2 id="323-extent-reuse"> <a href="#323-extent-reuse" class="anchor-heading" aria-labelledby="323-extent-reuse"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2.3. Extent Reuse</h2><div style="text-align: center;"> <img src="/assets/images/page-allocation.png" alt="page-allocation" /></div><p>WiredTiger manages space using an <code class="language-plaintext highlighter-rouge">extent</code> data structure, where each <code class="language-plaintext highlighter-rouge">extent</code> includes a logical disk offset and size. There are three extent lists for each file that keep track of:</p><ol><li><strong>Allocated Space</strong>: Extents currently in use, containing data.<li><strong>Available Space</strong>: Extents that are free and can be used for new data.<li><strong>Discarded Space</strong>: Extents that have been freed up after data is deleted or moved, and are awaiting reuse.</ol><p>As old versions are superseded by new ones and marked for deletion, the space they occupied is moved from the <code class="language-plaintext highlighter-rouge">allocated</code> list to the <code class="language-plaintext highlighter-rouge">available</code> or <code class="language-plaintext highlighter-rouge">discarded</code> list, depending on whether the space is immediately reusable.</p><p>Before a data buffer is actually written out, the latest update version is applied to the original on-disk image. Then, the space management system allocates the logical disk address for the upcoming write based on one of three approaches:</p><ol><li><strong>First-Fit</strong>: Selects the first extent in the available extent list that fits the data buffer.<li><strong>Best-Fit (default)</strong>: Selects the smallest extent that fits the data buffer.<li><strong>Append</strong>: Adds the data buffer at the end of the file.</ol><h2 id="324-space-reclamation"> <a href="#324-space-reclamation" class="anchor-heading" aria-labelledby="324-space-reclamation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2.4. Space Reclamation</h2><p>Through checkpoints and compaction processes, WiredTiger reclaims space from old, unused data versions, making it available for future writes. This ensures efficient space utilization and prevents the database from growing indefinitely.</p><p>The figure below illustrates how WiredTiger manages extent lists and reuses previously allocated space using checkpoints:</p><div style="text-align: center;"> <img src="/assets/images/live-checkpoint-1.png" alt="live-checkpoint-1" /></div><div style="text-align: center;"> <img src="/assets/images/live-checkpoint-2.png" alt="live-checkpoint-2" /></div><ol><li><strong>Checkpointing</strong>: Extent list information is maintained in the <code class="language-plaintext highlighter-rouge">checkpoint</code> structure and written to persistent storage during checkpointing.<li><strong>Live Checkpoint</strong>: WiredTiger uses a special checkpoint called the <strong>live checkpoint</strong>, which <em>only exists while the system is running and resides in DRAM</em>. This checkpoint tracks both data changes and updates to the extent lists.<li><strong>Merging Checkpoints</strong>: When the checkpoint server is signaled, the previous checkpoint is fetched from persistent storage and merged with the live checkpoint. After merging, the previous disk space occupied by the same data page is marked as available and can be reused for subsequent writes.</ol><p>This system ensures efficient space management, allowing WiredTiger to reuse space and maintain data consistency through checkpointing.</p></main><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2017-2020 Patrick Marsceill. Distributed by an <a href="https://github.com/just-the-docs/just-the-docs/tree/main/LICENSE.txt">MIT license.</a> <a href="https://www.netlify.com/">This site is powered by Netlify.</a></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/just-the-docs/just-the-docs/tree/main/docs/mongo03/02.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
