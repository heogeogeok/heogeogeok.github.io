<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"><link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"><style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(5)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(4) > ul > li:nth-child(5) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(4) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(4) > ul > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(4) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(4) > ul.nav-list > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; }</style><script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico" type="image/x-icon"><title>3.5. Logging | The Internals of MongoDB</title><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="3.5. Logging" /><meta property="og:locale" content="en_US" /><meta name="description" content="A Jekyll theme for documentation" /><meta property="og:description" content="A Jekyll theme for documentation" /><link rel="canonical" href="http://localhost:4000/docs/mongo03/05/" /><meta property="og:url" content="http://localhost:4000/docs/mongo03/05/" /><meta property="og:site_name" content="The Internals of MongoDB" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="3.5. Logging" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A Jekyll theme for documentation","headline":"3.5. Logging","url":"http://localhost:4000/docs/mongo03/05/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> The Internals of MongoDB </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 1. Databases and Collections category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo01" class="nav-list-link">1. Databases and Collections</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo01/01/" class="nav-list-link">1.1. Database Internals</a><li class="nav-list-item"><a href="/docs/mongo01/02/" class="nav-list-link">1.2. Architecture</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2. Memory Management category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo02" class="nav-list-link">2. Memory Management</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo02/01/" class="nav-list-link">2.1. Data Storage</a><li class="nav-list-item"><a href="/docs/mongo02/02/" class="nav-list-link">2.2. Indexes</a><li class="nav-list-item"><a href="/docs/mongo02/03/" class="nav-list-link">2.3. Concurrency Control</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 3. Block Manager category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/mongo03" class="nav-list-link">3. Block Manager</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/mongo03/01/" class="nav-list-link">3.1. Page Operations</a><li class="nav-list-item"><a href="/docs/mongo03/02/" class="nav-list-link">3.2. Checksum</a><li class="nav-list-item"><a href="/docs/mongo03/03/" class="nav-list-link">3.3. Space Management</a><li class="nav-list-item"><a href="/docs/mongo03/04/" class="nav-list-link">3.4. Compression</a><li class="nav-list-item"><a href="/docs/mongo03/05/" class="nav-list-link">3.5. Logging</a></ul><li class="nav-list-item"><a href="/docs/" class="nav-list-link">References</a></ul><ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/heogeogeok" class="nav-list-link external" > GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search The Internals of MongoDB" aria-label="Search The Internals of MongoDB" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div></div><div class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/docs/mongo03">3. Block Manager</a><li class="breadcrumb-nav-list-item"><span>3.5. Logging</span></ol></nav><div id="main-content" class="main-content"><main><h3 class="fs-10 text-center" id="35-logging"> <a href="#35-logging" class="anchor-heading" aria-labelledby="35-logging"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.5. LOGGING</h3><p>To ensure consistency and durability, MongoDB employs a <strong>journaling</strong> approach and periodically triggers <strong>checkpoints</strong> at defined intervals. Crashes between checkpoints, however, may result in a loss of writes that have not yet been written to disk. <strong>Write-ahead logging (WAL)</strong> provides a way to make these writes durable.</p><h3 id="write-ahead-logging-wal"> <a href="#write-ahead-logging-wal" class="anchor-heading" aria-labelledby="write-ahead-logging-wal"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Write-Ahead Logging (WAL)</h3><p>Write-Ahead Logging (WAL) is a family of techniques designed to provide atomicity and durability (two of the <strong>ACID</strong> properties) in database systems. WAL involves wrapping information about the current write operation and storing it durably before confirming the write to the client application. A log sequence number (LSN) is usually associated with each logged write to establish the happen-before relation between logs. Log records are stored in a memory log buffer and are later synchronously written to non-volatile storage by the WAL protocol. Upon failure, a data recovery scheme like <strong>ARIES</strong> replays all logs in LSN order to reconstruct the state of the database immediately prior to the crash.</p><div class="table-wrapper"><table><thead><tr><th><strong>Name</strong><th><strong>Definition</strong><tbody><tr><td><strong><code class="language-plaintext highlighter-rouge">alloc_lsn</code></strong><td>Next log record allocation<tr><td><strong><code class="language-plaintext highlighter-rouge">ckpt_lsn</code></strong><td>Last checkpoint<tr><td><strong><code class="language-plaintext highlighter-rouge">sync_lsn</code></strong><td>Last record synced to disk<tr><td><strong><code class="language-plaintext highlighter-rouge">write_lsn</code></strong><td>End of the last record written to the operating system<tr><td><strong><code class="language-plaintext highlighter-rouge">write_start_lsn</code></strong><td>Start of the last record written to the operating system</table></div><div style="text-align: center;"> <img src="/assets/images/writinglog.png" alt="writinglog" width="600" /></div><p>WiredTiger uses B-trees to store data in volatile memory. A <em><strong>snapshot</strong></em> is a consistent, durable view of these B-trees, which is periodically written out to disk. Starting from version 3.6, MongoDB configures WiredTiger to create checkpoints (i.e., write the snapshot data to disk) every 60 seconds. To provide durability in the event of failure between checkpoints, WiredTiger uses WAL to maintain on-disk journal files.</p><p>WiredTiger creates one log record for each client-initiated write operation. A log record wraps all internal write operations to WiredTiger’s in-memory data structures caused by the application-initiated write. A log record consists of a 16-byte header and data. The first 4 bytes of the header contain the length of the record, and this length is always a multiple of 4 bytes.</p><div style="text-align: center;"> <img src="/assets/images/checkpoints.png" alt="checkpoints" width="400" /></div><p>MongoDB configures WiredTiger to buffer all log records up to 128 KB in an in-memory data structure called the <em><strong>slot</strong></em>. Slots are synchronously flushed to non-volatile storage every 100 milliseconds or upon a full-sync write, whichever comes first. A full-sync write is a write operation that requires its journal record to be flushed to non-volatile storage before returning, ensuring that the written data survives a crash. This provides the strictest durability, in contrast to non-sync writes where the data is recorded in a buffer in memory but is not guaranteed to be immediately written to non-volatile storage. After a full-sync write is issued by the client to the query executor, all records in the slot buffer must be synchronized to non-volatile storage to commit the write.</p><h3 id="checkpoints"> <a href="#checkpoints" class="anchor-heading" aria-labelledby="checkpoints"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Checkpoints</h3><p>In addition to journaling, MongoDB periodically initiates a checkpoint process at specific intervals (every 60 seconds) or when the volume of log data written reaches a threshold (2 GB).</p><ol><li><strong>Write Dirty Leaf Pages</strong>:<ul><li>Instead of overwriting existing data, new versions of dirty leaf pages are written into free space on disk.</ul><li><strong>Write Internal Pages, Including the Root</strong>:<ul><li>The internal pages, along with the root page, are written. Importantly, the old checkpoint remains valid until this process is complete.</ul><li><strong>Sync the File</strong>:<ul><li>The file containing the new pages is synced to ensure all changes are properly written to disk.</ul><li><strong>Update Metadata with New Root Address</strong>:<ul><li>The new root page’s address is written to the metadata. Once the metadata is durable, pages from old checkpoints can be freed.</ul></ol><p>After every checkpoint, all journal records whose writes <em>happened before</em> the checkpoint are automatically garbage-collected, freeing space for future journal records. In this sense, the journal can be thought of as a circular buffer for write operations. WiredTiger keeps track of the current checkpoint and the current starting point for WAL in the journal file.</p><h3 id="recovery"> <a href="#recovery" class="anchor-heading" aria-labelledby="recovery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recovery</h3><p>When recovering from a crash, WiredTiger first looks in the data files for the identifier of the last checkpoint, then searches the journal files for the record that matches this identifier. WiredTiger then reads log records one by one from the journal file:</p><ol><li>It scans through the header to obtain metadata, such as the size of the entire record.<li>It reads through the data part of the log record according to the metadata.<li>After reading each record, it immediately applies it and continues to the next record until all records are consumed.</ol><p>This structured approach ensures that MongoDB can recover reliably and efficiently from crashes, maintaining the integrity and durability of the data.</p></main><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2017-2020 Patrick Marsceill. Distributed by an <a href="https://github.com/just-the-docs/just-the-docs/tree/main/LICENSE.txt">MIT license.</a> <a href="https://www.netlify.com/">This site is powered by Netlify.</a></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/just-the-docs/just-the-docs/tree/main/docs/mongo03/05.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
